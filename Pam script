#!/bin/bash
# CyberPatriot PAM Hardening Script
# Run as root: sudo ./pam_hardening.sh

echo "===================="
echo "  PAM Hardening Script"
echo "===================="

# Backup current PAM configs
echo "[*] Backing up PAM configs..."
mkdir -p /root/pam_backup
cp /etc/pam.d/common-auth /root/pam_backup/
cp /etc/pam.d/common-password /root/pam_backup/
cp /etc/pam.d/sshd /root/pam_backup/
echo "[*] Backup complete at /root/pam_backup/"

# 1. Enforce strong passwords (common-password)
echo "[*] Configuring strong password policy..."
sed -i '/pam_unix.so/ s/$/ minlen=12 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1/' /etc/pam.d/common-password
echo "[*] Strong password policy applied (min 12 chars, must include upper, lower, digit, special)."

# 2. Force password change on first login (example for user 'student')
echo "[*] Forcing password change on first login..."
chage -d 0 student

# 3. Account lockout after 3 failed attempts (common-auth)
echo "[*] Configuring account lockout..."
if ! grep -q "pam_tally2.so" /etc/pam.d/common-auth; then
    sed -i '/pam_unix.so/ i auth required pam_tally2.so onerr=fail deny=3 unlock_time=900' /etc/pam.d/common-auth
fi
echo "[*] Lockout policy applied (3 failed attempts, 15 min lock)."

# 4. Disable root login via SSH
echo "[*] Disabling root login via SSH..."
if ! grep -q "^PermitRootLogin no" /etc/ssh/sshd_config; then
    sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
    systemctl restart ssh
fi
echo "[*] Root login disabled."

echo "[*] PAM hardening complete."
