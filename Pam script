#!/bin/bash
# PAM Hardening Script
# Run as root: sudo ./pam_hardening.sh

set -e

echo "[*] Starting PAM hardening..."

# Backup PAM configs first
echo "[*] Backing up PAM configuration..."
mkdir -p /root/pam_backup
cp -r /etc/pam.d/* /root/pam_backup/

# Enforce password complexity using pam_pwquality
echo "[*] Updating /etc/security/pwquality.conf"
cat <<EOL >/etc/security/pwquality.conf
minlen = 12
dcredit = -1
ucredit = -1
ocredit = -1
lcredit = -1
enforce_for_root
EOL

# Configure password policies in common-password
echo "[*] Updating /etc/pam.d/common-password"
sed -i '/pam_unix.so/ s/$/ remember=5 minlen=12/' /etc/pam.d/common-password
if ! grep -q "pam_pwquality.so" /etc/pam.d/common-password; then
    sed -i '/pam_unix.so/ i\password requisite pam_pwquality.so retry=3' /etc/pam.d/common-password
fi

# Lock account after 3 failed login attempts using pam_tally2
echo "[*] Updating /etc/pam.d/common-auth for login attempts"
if ! grep -q "pam_tally2.so" /etc/pam.d/common-auth; then
    sed -i '/pam_unix.so/ i\auth required pam_tally2.so deny=3 unlock_time=900 onerr=fail audit' /etc/pam.d/common-auth
fi

# Force password change on next login for all users with empty passwords
echo "[*] Forcing password change for users with empty passwords"
awk -F: '($2==""){print $1}' /etc/shadow | while read user; do
    passwd -e "$user"
done

# Prevent root login via SSH (if applicable)
echo "[*] Updating /etc/ssh/ssh*]()
