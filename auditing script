#!/bin/bash
# CyberPatriot Linux Audit Script
# Run as root: sudo ./cp_audit.sh

echo "===================="
echo "  CyberPatriot Linux Audit"
echo "===================="
echo ""

# 1. Users and Groups
echo "[*] Checking users with empty passwords..."
awk -F: '($2==""){print $1}' /etc/shadow

echo ""
echo "[*] Checking sudo users..."
getent group sudo

echo ""
echo "[*] Listing all users..."
cut -d: -f1 /etc/passwd

# 2. Services
echo ""
echo "[*] Active services:"
systemctl list-units --type=service --state=running

echo ""
echo "[*] Listening TCP/UDP ports:"
ss -tuln

# 3. Installed packages (optional: show risky ones)
echo ""
echo "[*] Peer-to-peer and risky packages installed:"
dpkg -l | grep -E 'amule|transmission|vuze|qbittorrent|deluge|nicotine|ktorrent|frostwire|wireshark|apache2|nginx|telnet|rsh|sendmail|exim|postfix|mysql|postgresql'

echo ""
echo "[*] Leftover config files (rc packages):"
dpkg -l | grep '^rc'

# 4. File permissions
echo ""
echo "[*] World-writable files:"
find / -type f -perm -o+w 2>/dev/null

echo ""
echo "[*] SUID/SGID files:"
find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null

echo ""
echo "[*] Home directories permissions:"
ls -ld /home/*

# 5. Firewall
echo ""
echo "[*] Firewall status (ufw):"
ufw status verbose

# 6. Password policies
echo ""
echo "[*] Password expiration for all users:"
for user in $(cut -f1 -d: /etc/passwd); do
    echo "User: $user"
    chage -l $user
done

# 7. Logs
echo ""
echo "[*] Last 50 authentication log entries:"
tail -n 50 /var/log/auth.log

echo ""
echo "===================="
echo "Audit complete."
