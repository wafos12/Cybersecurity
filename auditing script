#!/bin/bash
# CyberPatriot Linux Auto-Audit & Cleanup Script
# Run as root: sudo ./cp_auto_cleanup.sh

LOGFILE="/tmp/cp_cleanup_$(date +%Y%m%d_%H%M%S).log"
echo "CyberPatriot Auto-Cleanup Log - $(date)" > $LOGFILE
echo "====================" >> $LOGFILE

# Function to log both console and logfile
log() {
    echo "$1"
    echo "$1" >> $LOGFILE
}

log "[*] Starting CyberPatriot Linux auto-audit & cleanup"

# 1. Users with empty passwords
log "[*] Users with empty passwords:"
awk -F: '($2==""){print $1}' /etc/shadow | tee -a $LOGFILE

# 2. Sudo users
log "[*] Sudo users:"
getent group sudo | tee -a $LOGFILE

# 3. Active services
log "[*] Active services:"
systemctl list-units --type=service --state=running | tee -a $LOGFILE

# 4. Listening TCP/UDP ports
log "[*] Listening TCP/UDP ports:"
ss -tuln | tee -a $LOGFILE

# 5. Risky/unnecessary packages
RISKY_PACKAGES=$(dpkg -l | grep -E 'amule|transmission|vuze|qbittorrent|deluge|nicotine|ktorrent|frostwire|wireshark|apache2|nginx|telnet|rsh|sendmail|exim|postfix|mysql|postgresql' | awk '{print $2}')

if [ ! -z "$RISKY_PACKAGES" ]; then
    log "[*] Removing risky packages:"
    for pkg in $RISKY_PACKAGES; do
        log "Purging $pkg"
        apt purge -y $pkg >> $LOGFILE 2>&1
    done
    # Auto-remove dependencies
    apt autoremove -y >> $LOGFILE 2>&1
else
    log "[*] No risky packages found."
fi

# 6. Leftover config files (rc)
RC_PACKAGES=$(dpkg -l | grep '^rc' | awk '{print $2}')
if [ ! -z "$RC_PACKAGES" ]; then
    log "[*] Purging leftover config files:"
    dpkg --purge $RC_PACKAGES >> $LOGFILE 2>&1
else
    log "[*] No leftover config files."
fi

# 7. File permissions
log "[*] World-writable files:"
find / -type f -perm -o+w 2>/dev/null | tee -a $LOGFILE

log "[*] SUID/SGID files:"
find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | tee -a $LOGFILE

# 8. Firewall status
log "[*] Firewall status (ufw):"
ufw status verbose | tee -a $LOGFILE

# 9. Password expiration
log "[*] Password expiration for all users:"
for user in $(cut -f1 -d: /etc/passwd); do
    log "User: $user"
    chage -l $user | tee -a $LOGFILE
done

# 10. Authentication logs
log "[*] Last 50 authentication log entries:"
tail -n 50 /var/log/auth.log | tee -a $LOGFILE

log "[*] CyberPatriot auto-audit & cleanup complete."
log "[*] Log saved at $LOGFILE"

